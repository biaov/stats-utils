"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const t=require("express"),e=require("dayjs"),n=require("axios"),s=require("dom-parser"),o=(t,e={})=>{const s=((t,e={})=>{const s=n.create({baseURL:t,timeout:1e4,headers:{...e,"Content-Type":"application/json"}});return s.interceptors.response.use((t=>t.data),(({response:t})=>Promise.reject(t))),s})(t,e);return t=>({get:(e={})=>s.get(t,{params:e}),post:(e={},n={})=>s.post(t,e,n)})},a=o("https://api.github.com/",{Authorization:`bearer ${process.env.GITHUB_TOKEN}`})("graphql"),i=o("https://blog.csdn.net/",{"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1"}),r={color:"#38bdae",background:"#1a1b27",title:"CSDN 数据",titleColor:"#70a5fd"},l=["color","background","titleColor"],c=t.Router();c.get("/github-stats",(async(t,n)=>{const{username:s}=t.query,o=e(),i=o.subtract(30,"days").toISOString(),r=o.add(1,"days").toISOString();if(s)try{const{data:{user:t}}=await a.post(((t,e,n)=>({query:"\n    query userInfo($name: String!, $from: DateTime!, $to: DateTime!) {\n      user(login: $name) {\n        name\n        contributionsCollection(from: $from, to: $to) {\n          contributionCalendar {\n            weeks {\n              contributionDays {\n                contributionCount\n                date\n              }\n            }\n          }\n        }\n      }\n    }\n  ",variables:{name:n,from:e,to:t}}))(r,i,s));if(t){const e={contributions:[],name:t.name};t.contributionsCollection.contributionCalendar.weeks.map((t=>t.contributionDays.map((t=>{e.contributions.push(t)}))));const{length:s}=e.contributions;0===e.contributions[s-1].contributionCount&&e.contributions.pop();const o=e.contributions.length-31;e.contributions.splice(0,o),n.json(e)}else n.status(422).json({message:"请检查你的用户名"})}catch(l){return l}else n.status(422).json({message:"请检查你的用户名"})})),c.get("/text-image",(async(t,e)=>{let{text:n,size:s=34,color:o="f56c6c"}=t.query;if(o=(o.includes("rgb")?"":"#")+o,!n)return void e.status(422).json({message:"文本内容必传"});const a=1.31*+s,i=+s*(t=>{let e=0;for(let n=0;n<t.length;n++){const s=t.charCodeAt(n);e+=s>=0&&s<=127||s>=65377&&s<=65439?1.5:2}return e})(n)/2,r=`<svg xmlns="http://www.w3.org/2000/svg" width="${i}" height="${a}" viewBox="0 0 ${i} ${a}">\n    <defs>\n      <style>\n        .cls-1 {\n          fill: #${o};\n          font-family: jiangxizhuokai-Regular, jiangxizhuokai;\n          font-size: ${s}px;\n        }\n      </style>\n    </defs>\n    <g>\n      <text class="cls-1" transform="translate(0 ${.7*a})"><tspan x="0" y="0">${n}</tspan></text>\n    </g>\n  </svg>`;e.setHeader("Content-Type","image/svg+xml"),e.send(r)})),c.get("/csdn/:username",(async(t,e)=>{const{username:n}=t.params;(t=>i(t))(n).get().then((n=>{const o=(t=>{const e=s.parseFromString(t),[n]=e.getElementsByClassName("personal-reward-box"),o=n.getElementsByClassName("num"),a=n.getElementsByClassName("name").map(((t,e)=>({label:t.textContent,value:o[e].textContent}))),[i]=e.getElementsByClassName("personal-tag-box");return i.getElementsByClassName("item").forEach((t=>{const e=t.getElementsByClassName("name")[0].textContent.slice(0,2),[n]=t.getElementsByClassName("num");if(!n)return;const s=n.textContent;a.length<6&&a.push({label:e,value:s})})),a})(n);e.setHeader("Content-Type","image/svg+xml"),e.send(((t,e)=>{Object.entries(e).forEach((([t,e])=>{r[t]=(l.includes(t)&&e.includes("rgb")?"":"#")+e}));const n=t.reduce(((t,e,n)=>{const s=~~(n/2);return`${t}<text x="${n%2?200:30}" y="${70+35*s}" class="stats bold animation" dominant-baseline="middle" style="animation-delay:${300*s}ms;">${e.label}：${e.value}</text>`}),"");return`<svg xmlns="http://www.w3.org/2000/svg"\n    xmlns:xlink="http://www.w3.org/1999/xlink" width="340" height="180" viewBox="0 0 340 180">\n    <style>\n    @keyframes fade-in{0%{opacity:0;}100%{opacity:1;}}.animation{opacity:0;animation:fade-in 300ms ease-in-out forwards;}.bold{font-weight:600;}.stats,.title{font-family:'Segoe UI',Ubuntu,Sans-Serif,'Helvetica Neue','PingFang SC','Microsoft YaHei';}.stats{font-size:14px;fill:${r.color};}.title{font-size:18px;fill:${r.titleColor};}\n    </style>\n    <rect width="100%" height="100%" rx="4.5" fill="${r.background}" />\n    <text x="50%" y="30" class="title bold animation" dominant-baseline="middle" text-anchor="middle">${r.title}</text>\n    ${n}\n  </svg>`})(o,t.query))})).catch((()=>{e.status(422).json({message:`请检查 ${n} 是否正确`})}))}));const u=t();u.use("/api",c),u.listen(4e3),exports.app=u;
